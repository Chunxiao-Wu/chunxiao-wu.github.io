@{
    Layout = "~/Areas/Member/Views/_LoginLayoutPage.cshtml";
    ViewBag.Title = "找回密码";
    CurrentUser findUser = (CurrentUser)ViewBag.FindUser;
    string mobile = findUser.Mobile;
    string mobileXxx = "";
    if (StringHelper.IsMobile(mobile))
    {
        mobileXxx = mobile.Substring(0, 3) + "******" + mobile.Substring(8, 3);
    }
    string email = findUser.Email;
    string emailXxx = "";
    if (StringHelper.IsEmail(email))
    {
        int secondStart = email.IndexOf("@");
        emailXxx = email.Substring(0,2) + "******" + email.Substring(secondStart - 1);
    }
}
<div class="container cxform" id="findPassword">
    <div class="loginBox clearfix" id="loginbox">
        <div class="content-box">
            <div class="media logo-media"></div>
            <div class="login-sign">找回密码</div>
            <el-form ref="form" label-position="top" v-if="Open==1">
                <el-form-item label="找回方式">
                    <el-select v-model="formData.FindType" placeholder="请选择" style="width:100%" v-validate="{data:formData.FindType,dataType:'*',nullMsg:'请选择身份验证方式'}">
                        @if (ViewBag.FindByEmail == "1" && !string.IsNullOrEmpty(emailXxx))
                        {
                            <el-option key="email"  label="邮箱验证 @emailXxx" value="email"></el-option>
                        }

                        @if (ViewBag.FindByMobile == "1" && !string.IsNullOrEmpty(mobileXxx))
                        {
                            <el-option key="mobile"  label="手机验证 @mobileXxx" value="mobile"></el-option>
                        }
                        <el-option key="else" label="人工申诉" value="else"></el-option>
                    </el-select>
                    <span class="help-block validate-tips-box">请填写要找回的帐号、或账号绑定的邮箱或手机</span>
                </el-form-item>

                <el-form-item label="邮箱账户" v-show="formData.FindType=='email'">
                    <el-input  placeholder="" v-model.trim="formData.Email" id="email" v-validate="{data:formData.Email,dataType:'email',nullMsg:'请填写邮箱账户!',errorMsg:'邮箱账户填写错误!',ignore:(formData.FindType=='email'?false:true)}"></el-input>
                    <span class="help-block validate-tips-box">请填写账户绑定的邮箱账户</span>
                </el-form-item>

                <el-form-item label="邮件验证码" v-show="formData.FindType=='email'">
                    <ui-input-code placeholder="点击右侧按钮获取邮件验证码" v-model.trim="formData.EmailCode"  focus-target="#email"  :account="formData.Email"  url-api="/E/EmailCode/Send" v-validate="{data:formData.EmailCode,dataType:'numeric',minLength:6,minLengthErrorMsg:'邮件验证码为6位数字！',nullMsg:'请填写邮件验证码',ignore:(formData.FindType=='email'?false:true)}"></ui-input-code>
                    <span class="help-block validate-tips-box"></span>
                </el-form-item>

                <el-form-item label="手机号码" v-show="formData.FindType=='mobile'">
                    <el-input placeholder="" v-model.trim="formData.Mobile" id="mobile" v-validate="{data:formData.Mobile,dataType:'mobile',nullMsg:'请填写手机号码!',errorMsg:'手机号码填写错误!',ignore:(formData.FindType=='mobile'?false:true)}"></el-input>
                    <span class="help-block validate-tips-box">请填写账户绑定的手机号码</span>
                </el-form-item>

                <el-form-item label="手机验证码" v-show="formData.FindType=='mobile'">
                    <ui-input-code placeholder="点击右侧按钮获取邮件验证码" v-model.trim="formData.SmsCode" focus-target="#mobile"  type="mobile" :account="formData.Mobile" url-api="/E/SmsCode/Send" v-validate="{data:formData.SmsCode,dataType:'numeric',minLength:6,minLengthErrorMsg:'验证码为6位数字！',nullMsg:'请填写手机验证码',ignore:(formData.FindType=='mobile'?false:true)}"></ui-input-code>
                    <span class="help-block validate-tips-box"></span>
                </el-form-item>
                <el-form-item label="找回说明" v-show="formData.FindType=='else'">
                    <span class="help-block validate-tips-box">如果您账户没有绑定邮箱或手机号，只能联系网站客服人员帮您找回密码。</span>
                </el-form-item>
                @if (ViewBag.VerificationCode == "1")
                {
                    <el-form-item label="验证码*" v-show="formData.FindType!='else'">
                        <el-input v-model="formData.VerificationCode" id="verificationCode" maxlength="4" placeholder="输入右侧的验证码" v-validate="{data:formData.VerificationCode,dataType:'*',minLength:4,minLengthErrorMsg:'验证码最少4个字符',focusTarget:'#verificationCode',nullMsg:'请填写验证码!'}">
                            <template slot="append">
                                <ui-verification-code-image src="/E/VerificationCode/?width=100&height=30"></ui-verification-code-image>
                            </template>
                        </el-input>
                        <span class="help-block validate-tips-box"></span>
                    </el-form-item>
                }
                <el-form-item >
                    <div class="controls button-spacing">
                        <el-button type="primary" v-on:click="postSubmit" :disabled="formData.FindType=='else'">下一步</el-button>
                    </div>
                </el-form-item>
                <div class="row">
                    <div class="pull-left">
                        <a href="@Url.ActionUrl("Index")">上一步</a>
                    </div>
                    <div class="pull-right">
                        没有账户？<a href="@Url.ActionUrl("Index", "Reg")" class="text-primary">去注册</a>
                    </div>
                </div>
            </el-form>
        </div>
    </div>
</div>
<script type="text/javascript">
    @{
        string findType = "else";
        if (ViewBag.FindByEmail == "1" && !string.IsNullOrEmpty(emailXxx))
        {
            findType = "email";
        }
        else if (ViewBag.FindByMobile == "1" && !string.IsNullOrEmpty(mobileXxx))
        {
            findType = "mobile";
        }
    }
    var formData = { FindType: "@findType", EmailCode: "", SmsCode: "",VerificationCode: "",Email:"",Mobile:""};
    //vue实例化
    var vue = new Vue({
        el: "#findPassword",
        data: {
            formData: formData,
            Open:@ViewBag.Open,
        },
        methods: {
            postSubmit: function () {
                var validated = this.validateForm({ });//jquery表单验证
                if (validated) {
                    this.submit({ url: "@Url.ActionUrl("Confirm")", data: formData, showSuccessMsg: false, success: loginSuccess });
                }
            },
        },
    });
    function loginSuccess(result)
    {
        location.href = "@Url.ActionUrl("ModifyPassword")";
    }
    addEvent(window, 'keyup', function (event) {
        if (event.keyCode == 13) {
            vue.postSubmit();
        }
    });
    function init() {
        var $body = document.querySelector("body");
        var winHeight = clientSize().height;
        var $loginBox = document.querySelector("#loginbox");
        var mHeight = $loginBox.offsetHeight;
        var topMargin = parseInt(winHeight / 2) - parseInt(mHeight / 2) - 40;
        if (topMargin <= 10) {
            topMargin = 10;
        }
        $loginBox.style.marginTop = topMargin + "px";
    }
    document.ready(function () {
        init()
    });
    window.onresize = init;
</script>
