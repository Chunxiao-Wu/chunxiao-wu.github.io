@using PageAdmin.Utils
@{
    dynamic permissionsSet = ViewBag.PermissionsSet;
    CurrentUser user = ViewBag.CurrentUser;
    int tableId = ViewBag.TableId;
    string table = ViewBag.Table;
    string action = ViewContext.RouteData.Values["action"].ToString().ToLower();
    IEnumerable<dynamic> fieldData = Html.GetFieldList((string)ViewBag.Table, action, user);
    var guid = Html.Guid();
    int historyColumnId = StringHelper.Format<int>(Request.QueryString["columnId"]);
    var columnTree = Html.GetColumnTree(tableId,user,PageAdmin.Common.FromEnum.Member);
}
<script src="~/Incs/UEditor/ueditor.forAdmin.config.js" type="text/javascript"></script>
<script src="~/Incs/UEditor/ueditor.all.min.js" type="text/javascript"></script>
<div class="main" id="main">
            <el-form label-width="150px" label-position="left">
                <el-form-item label="所属栏目*" v-show="ignoreColumn==false">
                    <ui-cascader v-model="formData.ColumnId" placeholder="请选择栏目" :options="@JsonHelper.JsonParse(columnTree)" :props="{ expandTrigger: 'hover',multiple:false }" v-validate="{data:formData.ColumnId,dataType:'*',min:1,nullMsg:'请选择栏目!',ignore:ignoreColumn}"></ui-cascader>
                    <span class="help-block"></span>
                </el-form-item>
                @{
                    string beforeSubmitJs = "";
                    var data = new ViewDataDictionary();
                    data.Add("from", PageAdmin.Common.FromEnum.Member);
                    data.Add("currentUser", user);
                    data.Add("guid", guid);
                    data.Add("fieldPrefix", "formData");
                    data.Add("i", 0);
                    int i = 0;
                    if (fieldData != null)
                    {
                        foreach (var row in fieldData)
                        {
                            data["i"] = i;
                            beforeSubmitJs += row.BeforeSubmitJs;
                            Html.RenderPartial("~/Areas/E/Views/CustomForm/FormPartial.cshtml", (object)row, data);
                            i++;
                        }
                    }
                }

            </el-form>

    <div class="footer-submit-bar" style="padding-left:150px">
        <el-button type="primary" v-on:click="postSubmit">提交保存</el-button>
        <el-button onclick="closeSelf()">关闭</el-button>
    </div>
</div>

<script type="text/javascript">
    var action = "@action";
    var postUrl = "@Url.ActionUrl()";
    var formData = @Html.RawModel((string)Model);
    formData.Guid = "@guid";
    if ("@action"=="add")
    {
        formData.State = 1;
        //刷新后保存上次的栏目id，避免再次选择
        var historyColumnId = @historyColumnId;
        if (historyColumnId!=0)
        {
            formData.ColumnId = historyColumnId ;
        }
    }

    //提交前执行
    function beforeSubmitExecute() {
        @Html.Raw(beforeSubmitJs)
        return true;
    }
      var vue= new Vue({
          el: "#main",
          data: {
              formData: formData
          },
         computed: {
              ignoreColumn: function ()
              {
                  return @(columnTree.Count())<=0;
              }

          },
          methods: {
              postSubmit: function () {
                    var validated = this.validateForm({ beforeSubmit:function (){ return beforeSubmitExecute() }});//jquery表单验证
                    if (validated)
                    {
                        this.submit({ url: postUrl, data: formData, success: function () { callBack() }});
                    }
              },
          },
    });

      function callBack() {
            parent.loadData();
            if (action == "add") {
                location.href = "@Url.ActionUrl("Add")?table=@table&columnId=" +formData.ColumnId;
            }
        }
</script>
