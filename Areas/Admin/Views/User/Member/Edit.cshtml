@{
    CurrentUser user = ViewBag.CurrentUser;
    string action = ViewContext.RouteData.Values["action"].ToString();
    IEnumerable<dynamic> fieldData = Html.GetFieldList((string)ViewBag.Table, action, user, PageAdmin.Common.FromEnum.Member);
    string guid = Html.Guid();
}
<style>
    .el-button [class*="fa"] + span {
        margin-left: 5px;
    }
</style>
<div class="main" id="main">
    <div style="padding-bottom:15px"><b>基本信息</b></div>
    <el-form ref="form" label-width="130px" label-position="left">
        <el-row>
            <el-col :span="12">
                <el-form-item label="用户名">
                    <el-input v-model="formData.Username" disabled style="max-width:500px;" maxlength="18">
                        <el-button slot="append" icon="fa fa-sign-in" v-on:click="goMember()">会员中心</el-button>
                    </el-input>
                    <span class="help-block validate-tips-box"></span>
                </el-form-item>
            </el-col>
            <el-col :span="12">
                <el-form-item label="注册时间">
                    <el-input v-model="formData.RegDate" disabled style="max-width:500px;" maxlength="18"></el-input>
                    <span class="help-block validate-tips-box"></span>
                </el-form-item>
            </el-col>
        </el-row>
        <el-row>
            <el-col :span="12">
                <el-form-item label="密码">
                    <el-input v-model="formData.Password" style="max-width:500px;" maxlength="30" placeholder="不修改密码则留空">
                        <el-button slot="append" icon="el-icon-edit-outline" v-on:click="updatePassword">更新密码</el-button>
                    </el-input>
                    <input type="hidden" name="oldPassword" id="oldPassword">
                    <span class="help-block validate-tips-box"></span>
                </el-form-item>
            </el-col>
            <el-col :span="12">
                <el-form-item label="注册IP">
                    <el-input v-model="formData.RegDate" disabled style="max-width:500px;" maxlength="18"></el-input>
                    <span class="help-block validate-tips-box"></span>
                </el-form-item>
            </el-col>
        </el-row>
        <el-row>
            <el-col :span="12">
                <el-form-item label="用户组">
                    <div style="max-width:500px;white-space:nowrap;display:flex;">
                        <ui-select v-model="formData.MemberGroupId" :multiple="false" :clearable="false" style="flex-grow:1" v-bind:options="@Html.GetOptionsJson("pa_member_group","name","","Rank asc")"></ui-select>
                        <el-button type="primary" icon="el-icon-edit-outline" v-on:click="update" style="background-color:#f5f7fa;color:#909399;padding:12px 20px 11px 20px;border:1px solid #DCDFE6;margin-left:-8px;z-index:3;position:relative;border-bottom-left-radius:0px;border-top-left-radius:0px;">
                            更新组别
                        </el-button>
                    </div>
                    <span class="help-block validate-tips-box"></span>
                </el-form-item>
            </el-col>
            <el-col :span="12">
                <el-form-item label="最后登陆时间">
                    <el-input v-model="formData.LastDate" disabled style="max-width:500px;"></el-input>
                    <span class="help-block validate-tips-box"></span>
                </el-form-item>
            </el-col>
        </el-row>
        <el-row>
            <el-col :span="12">
                <el-form-item label="部门">
                    <div style="max-width:500px;white-space:nowrap;display:flex;">
                        <ui-cascader v-model="formData.DepartmentId" style="flex-grow:1" :options="@Html.GetTreeJson("pa_department","name","","xuhao asc")"></ui-cascader>
                        <el-button type="primary" icon="el-icon-edit-outline" 
                                   v-on:click="update"
                                   style="background-color:#f5f7fa;color:#909399;padding:12px 20px 11px 20px;border:1px solid #DCDFE6;margin-left:-8px;z-index:3;position:relative;border-bottom-left-radius:0px;border-top-left-radius:0px;">
                            更新部门
                        </el-button>
                    </div>
                    <span class="help-block validate-tips-box"></span>
                </el-form-item>
            </el-col>
            <el-col :span="12">
                <el-form-item label="最后登陆IP">
                    <el-input v-model="formData.LastIp" disabled style="max-width:500px;">
                    </el-input>
                    <span class="help-block validate-tips-box"></span>
                </el-form-item>
            </el-col>
        </el-row>
        <el-row>
            <el-col :span="12">
                <el-form-item label="手机">
                    <el-input style="max-width:500px;" v-model="formData.Mobile" v-validate="{data:formData.Mobile,dataType:'mobile',ignoreEmpty:true,errorMsg:'手机号码格式错误！'}" maxlength="15">
                        <template slot="append" icon="el-icon-chat-square">
                            <el-checkbox v-model="formData.MobileState" :label="formData.MobileState==1?'已验证':'未验证'" disabled :true-label="1" :false-label="0"></el-checkbox>
                        </template>
                    </el-input>
                    <span class="help-block" id="_ValidateTips_Mobile"></span>
                </el-form-item>
            </el-col>
            <el-col :span="12">
                <el-form-item label="登录次数">
                    <el-input style="max-width:500px;" disabled v-model="formData.Logins"></el-input>
                    <span class="help-block validate-tips-box"></span>
                </el-form-item>
            </el-col>
        </el-row>
        <el-row>
            <el-col :span="12">
                <el-form-item label="邮箱">
                    <el-input style="max-width:500px;" v-model="formData.Email" v-validate="{data:formData.Email,dataType:'email',ignoreEmpty:true,errorMsg:'邮箱地址格式错误！'}" maxlength="50">
                        <template slot="append" icon="el-icon-chat-square">
                            <el-checkbox v-model="formData.EmailState" :label="formData.EmailState==1?'已验证':'未验证'" disabled :true-label="1" :false-label="0"></el-checkbox>
                        </template>
                    </el-input>
                    <span class="help-block" id="_ValidateTips_Email"></span>
                </el-form-item>
            </el-col>
            <el-col :span="12"><div class="grid-content bg-purple-light"></div></el-col>
        </el-row>
        <div class="main" style="margin-top:15px" id="customField">
            <div style="margin:0px -15px 15px -15px"><b>其它信息</b></div>
            @{
                string beforeSubmitJs = "";
                var data = new ViewDataDictionary();
                data.Add("from", PageAdmin.Common.FromEnum.Admin);
                data.Add("guid", guid);
                data.Add("currentUser", ViewBag.CurrentUser);
                data.Add("memberGroupId", ViewBag.MemberGroupId);
                data.Add("fieldPrefix", "formData");
                data.Add("i", 0);
                int i = 0;
                if (fieldData != null)
                {
                    foreach (var row in fieldData)
                    {
                        data["i"] = i;
                        beforeSubmitJs += row.BeforeSubmitJs;
                        Html.RenderPartial("~/Areas/E/Views/CustomForm/FormPartial.cshtml", (object)row, data);
                        i++;
                    }
                }

            }
        </div>
    </el-form>
    <div class="footer-submit-bar" style="padding-left:100px">
        <el-button type="primary" v-on:click="postSubmit">提交</el-button>
        <el-button onclick="closeSelf()">关闭</el-button>
    </div>
</div>
<script src="~/Incs/UEditor/ueditor.forAdmin.config.js" type="text/javascript"></script>
<script src="~/Incs/UEditor/ueditor.all.min.js" type="text/javascript"></script>
<script type="text/javascript">
    function BeforeSubmit()
    {
        @Html.Raw(beforeSubmitJs)
        return true;
    }
    //绑定数据
    var id = "@Request.QueryString["id"]";
    var formData = @Html.RawModel((string)Model);
    formData.OldPassword = formData.Password;
    formData.Password = "";
    formData.Guid = "@guid";
    var vue = new Vue({
        el: "#main",
        data: {
            formData: formData,
        },
        methods: {
            goMember: function () {
                window.open("@Url.ActionUrl("GoMember")?uid=" + formData.Id, "_blank");
            },
            updatePassword: function () {
                var _this = this;
                if (formData.Password == "") {
                    _this.$notify.error({
                        title: '错误',
                        message: '密码不能为空！'
                    });
                    return false;
                }
                if (formData.Password.length < 6) {
                    _this.$notify.error({
                        title: '错误',
                        message: '密码最少6位数'
                    });
                    return false;
                }
                _this.postSubmit(true);
            },
            update: function () {
                var _this = this;
                _this.postSubmit(true);
            },
            postSubmit: function (validated) {
                var newFormData = JSON.parse(JSON.stringify(formData));
                if (newFormData.DepartmentId != undefined && newFormData.DepartmentId != null && newFormData.DepartmentId != "" && newFormData.DepartmentId != 0)
                {
                    newFormData.DepartmentId = newFormData.DepartmentId[newFormData.DepartmentId.length - 1];
                }
                if (validated != true)
                {
                    validated = false;
                }
                if (validated == false)
                {
                    validated = this.validateForm({ beforeSubmit: function () { return BeforeSubmit() } });//jquery表单验证
                }
                if (validated) {
                    this.submit({ url: "@Url.ActionUrl("Edit")", data: formData, success: function () { postRefreshBack() } });
                }
            }
        },
        watch: {
        }
    });
    function postRefreshBack() {
        parent.loadData();
    }
</script>