<style>
    .el-dialog__wrapper {
        overflow: hidden;
    }

</style>
<div class="main" id="main">
    <div class="breadcrumb-box">
        <el-breadcrumb separator="/">
            <el-breadcrumb-item><i class="fa fa-home fa-fw"></i><a href="javascript:void(0)" onclick="location.href=location.href">模板管理</a></el-breadcrumb-item>
        </el-breadcrumb>
    </div>
    <div class="menu-bar-box">
        <el-button size="small" v-on:click="submit({url:'@Url.ActionUrl("Delete")',data:{name:getSelectedPropertys(selectList,'Name'),type:getSelectedPropertys(selectList,'Type'),path:path.join('/')},confirmMsg:'确定删除吗？',success:'loadData()',beforeExecute:function(){return checkSelectedItems(selectList)},})">
            删除
        </el-button>
        <el-dropdown>
            <el-button size="small">
                功能菜单<i class="el-icon-arrow-down el-icon--right"></i>
            </el-button>
            <el-dropdown-menu slot="dropdown">
                <el-dropdown-item><a href="javascript:void(0)" v-on:click="dialog({title:'新建文件',url:'@Url.ActionUrl("AddFile")',width:'500px',height:'220px',target:'self'})">新建文件</a></el-dropdown-item>
                <el-dropdown-item><a href="javascript:void(0)" v-on:click="dialog({title:'新建目录',url:'@Url.ActionUrl("AddFolder")',width:'500px',height:'220px',target:'self'})">新建目录</a></el-dropdown-item>
                <el-dropdown-item class="divider"></el-dropdown-item>
                <el-dropdown-item><a href="javascript:void(0)" v-on:click="submit({url:'@Url.ActionUrl("Zip")', success:'loadData()',data:{name:getSelectedPropertys(selectList,'Name'),path:path.join('/')},confirmMsg:'确定压缩吗？',successMsg:'已经提交，请稍后查看',beforeExecute:function(){return checkSelectedItems(selectList)},})">打包压缩</a></el-dropdown-item>
                <el-dropdown-item><a href="javascript:void(0)" v-on:click="dialog({title:'文件上传',url:'@Url.ActionUrl("Upload")?path='+rootPath,width:'700px',height:'400px',target:'self'})">上传文件</a></el-dropdown-item>
            </el-dropdown-menu>
        </el-dropdown>
    </div>
    <table border=0 cellpadding=0 cellspacing=0 class="table table-bordered" style="margin-bottom:5px">
        <tr>
            <td>
                <span class="fa fa-folder-o"> </span>
                <span v-for="(item,index) in fullPath">
                    <a href="javascript:void(0)" v-on:click="openPath(index)" class="text-primary"> {{item}} </a><span v-show="index>0">/</span>
                </span>
            </td>
        </tr>
    </table>
    <div class="table-list-box">
        <template>
            <el-table ref="multipleTable" :data="dataList" tooltip-effect="dark" style="width: 100%" v-on:selection-change="handleSelectionChange" border>
                <el-table-column type="selection" width="40"> </el-table-column>
                <el-table-column label="名称" class-name="fa-eye-hover">
                    <template slot-scope="scope">
                        <span class="fa fa-folder" v-show="scope.row.Type==0" v-on:click="openFolder(scope.row.Name)"><span style="color:#666;cursor:pointer;"> {{scope.row.Name}}</span></span>
                        <span class="fa fa-file-text-o" v-show="scope.row.Type==1"> {{scope.row.Name}}</span>
                        <a href="javascript:void(0)" class="sp_extract text-info" v-show="scope.row.Name.toLowerCase().lastIndexOf('.zip')>0" v-on:click="submit({url:'@Url.ActionUrl("Extract")',success:function(){loadData()},data:{name:scope.row.Name,path:path.join('/')},confirmMsg:'解压后将覆盖同名文件，是否确定解压？',successMsg:'已经提交解压，请稍后查看'})">[解压]</a>
                        <a :href="preview(scope.row.Name)" target="_blank" title="预览"><span class="fa fa-eye" v-show="scope.row.Type==1"></span></a>
                    </template>
                </el-table-column>
                <el-table-column label="创建日期" prop="CreationTime" align="center"></el-table-column>
                <el-table-column label="修改日期" prop="LastWriteTime" align="center"></el-table-column>
                <el-table-column label="文件大小" align="center">
                    <template slot-scope="scope">
                        <span v-if="scope.row.Type==1">{{scope.row.FileLength}}kb</span>
                        <span v-else>-</span>
                    </template>
                </el-table-column>
                <el-table-column label="管理" align="center">
                    <template slot-scope="scope">
                        <div class="el-button-group">
                            <el-button size="small" v-on:click="dialog({title:'改名',url:'@Url.ActionUrl("ReName")?name='+encodeURIComponent(scope.row.Name)+'&path='+pathString+'&type='+scope.row.Type,target:'self',width:'550px',height:'320px'})">改名</el-button>
                            <el-button size="small" v-on:click="dialog({title:'',url:'@Url.ActionUrl("Edit")?name='+encodeURIComponent(scope.row.Name)+'&path='+pathString,target:'self'})" :disabled="scope.row.Type==0">编辑</el-button>
                            <el-button size="small" v-on:click="submit({url:'@Url.ActionUrl("Delete")',data:{name:scope.row.Name,type:scope.row.Type,path:path.join('/')},confirmMsg:'确定删除吗？',success:loadData})">删除</el-button>
                        </div>
                    </template>
                </el-table-column>
            </el-table>
        </template>
    </div>

</div>


<script type="text/javascript">
    //注册列表常用方法
    var rootPath = "/";
    if (rootPath == "/") {
        rootPath = "/Templates/@(ViewBag.CurrentTemplateDirectory)/";
    }

    var loadUrl = "@Url.ActionUrl("ListData", "TemplateManager")";
    //vue实例化
    var vue = new Vue({
        el: "#main",
        data: {
            dataList: [],
            path: [],
            selectList: [],
            rootPath: rootPath,
        },
        methods: {
            openFolder: function (name) {
                this.path.push(name);
            },
            openPath: function (index) {
                this.path.splice(index, this.path.length - index);
            },
            preview: function (name) {
                var fullPath = "";
                if (this.path.length == 0) {
                    fullPath = rootPath + name;

                } else {
                    fullPath = rootPath + this.path.join("/") + "/" + name;
                }
                return fullPath;
            },
            loadData: function () {
                loadData();
            },
            handleSelectionChange: function(val) {
                this.selectList = val;
            }

        },
        computed: {
            fullPath: function () {
                var fullPath = JSON.parse(JSON.stringify(this.path)); //避免直接引用，会同时触发path的改变
                fullPath.unshift(rootPath);
                return fullPath;
            },
            pathString: function () {
                return encodeURIComponent(this.path.join("/"));
            }
        },
        watch: {
            path: {
                handler: function(newName, oldName) {
                    loadData();
                },
                immediate: false
            }
        }
    });
    var uploadConfigData = { fileType: "files", fileNumLimit: "0", fileSizeLimit: "0", fileSingleSizeLimit: "0", extensions: "*", mimeTypes: "*/*", tableName: "", fieldName: "", watermark: false, thumbnail: false, thumbnailWidth: "200", thumbnailHeight: "200", sortByDate: false, sortByFileType: false, rename: false, savePath: "/", saveFileName: "", deleteRepeat: true, saveToAttachmentData: false, callback: function () { loadData() }, guid: "" };
    //加载数据
    function loadData() {
        var currentPath = vue.path.join("/");
        uploadConfigData.savePath = "/" + currentPath;
        vue.ajax({
            url: loadUrl,
            data: { path: currentPath },
            success: function (data) {
                if (Array.isArray(data)) {
                    vue.dataList = data;
                }
            }
        });
    }
    loadData();
</script>